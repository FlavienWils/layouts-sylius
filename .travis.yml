dist: trusty
sudo: false

language: php

php:
  - 7.2
  - 7.3

cache:
  directories:
    - $HOME/.composer

env:
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~3.4.0"
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~4.1.0"
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="^4.2@dev"

matrix:
  include:
    -
      php: 7.2
      env: PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~3.4.0" DEPS="low"
    -
      php: 7.2
      env: RUN_PHPSTAN="yes"
    -
      env: ~
      php: ~
      cache: ~
      language: node_js
      node_js: node
      before_script: npm install -g grunt-cli
      script: grunt build

branches:
  only:
    - master
    - /^\d.\d+$/

before_script:
  - phpenv config-rm xdebug.ini || true
  - echo "memory_limit=-1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

  # Read-only OAuth token to work around GitHub API rate limits
  - composer config -g github-oauth.github.com "4b3b0a83ea27d9544d3608a384c7a14625a98804"

  # Install Flex as a global dependency to enable usage of extra.symfony.require
  # while keeping Flex recipes from applying
  - composer global require --no-scripts symfony/flex

  - if [ "$SYMFONY_VERSION" != "" ] ; then composer config extra.symfony.require $SYMFONY_VERSION ; fi

  - |
    if [ "$DEPS" = "low" ] ; then
      composer update --no-suggest --prefer-dist --prefer-lowest --prefer-stable
    else
      composer update --no-suggest --prefer-dist
    fi

script:
  - composer validate --strict
  - if [ "$PHPUNIT_CONFIG" != "" ] ; then vendor/bin/phpunit -c $PHPUNIT_CONFIG --colors=always ; fi
  - if [ "$RUN_PHPSTAN" != "" ] ; then composer phpstan ; fi
  - if [ "$RUN_PHPSTAN" != "" ] ; then composer phpstan-tests ; fi

notifications:
  email: false
  slack:
    rooms:
      - secure: "gNMSEh/yvp9Cqko49UUf6WWLrAGGBmHwhZAy0cO6eyQ8RZ6nLcH7reygey4LLNdIo6IZR5zq0N64e3qNdn3RQW7TEb7HrwFq4UPibZvz6JnCJf/RwNboK/7o+uoZNwaNPPLwRjsbSVUDsklsUFqbZiFymh/qhozkqApKfJEyeGRratPiJlKLQTaQRn0nlCQjZ4cSfLdCf1Dc7BrurbGaIe1qIw6GlpM/cUFbHB+wgSrLezNQQRO/Qp7tq5wwcWmhJ5cGjfZ94fCplnnQoBclnFcujRUZhL0br3u4j2kTC0lcDRlqoyqXqXNUcFU1oTHAkgOkxUk5ch7Vcz+YYeB/p7QMk4Vp6v1ogYXnI0CdZ9+otVHEyl8iTOjyB6CxVIz8T9T5N12z8+bJyB/oa2G89GS7hPDlpwiun9icBtbwBcjrVxuFvJ1BZjwki7mKEVKhsfoTpLo2auS/rtq12E0i4OgvxJCKO6zM7lEZAQM9Q05YlSQcDX7ME/JtvPWKFi72+FjxcX0wOsoB/hPf6ybmgny8yVEHy/Gq/NlF/P39WljbW8Wt1elaqb+mCYv2GkRSmdsieLYcRwCO8wJabVDsDtq6Bs3VQSBKSvWTdR/nueU0l9buRDMG36FMVgSh/xKAzKbmVKr8sW+V+6T3SoCEy+VC+d85YrZOnLD/3Dzbaz4="
    on_success: change
    on_failure: always
    on_pull_requests: false

git:
  depth: 1
